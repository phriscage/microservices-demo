{{ define "login" }}
  {{ template "header" . }}
    {{ if $.firebase_config}}
      <script type="text/javascript">
        // Initialize Identity Platform Configuration
        // Copy this from Web Setup in the Identity Platform Console
        var config = {
          apiKey: {{ $.firebase_config.ApiKey }},
          authDomain: {{ $.firebase_config.AuthDomain }},
          projectId: {{ $.firebase_config.ProjectId }}
        };
        firebase.initializeApp(config);
      </script>
      <script type="text/javascript">
        // FirebaseUI config.
        var uiConfig = {
           callbacks: {
             // Called when the user has been successfully signed in.
             'signInSuccessWithAuthResult': function(authResult, redirectUrl) {
               if (authResult.user) {
                 handleSignedInUser(authResult.user);
               }
               // Do not redirect.
               return false;
             }
           },
          // Modify signInSuccessUrl for your GAE App Config
          signInSuccessUrl: {{ $.firebase_config.SignInSuccessUrl }},
          signInOptions: [
            // Leave the lines as is for the providers you want to offer your users.
            {
              provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
              authMethod: 'https://accounts.google.com'
            },
            firebase.auth.FacebookAuthProvider.PROVIDER_ID,
            firebase.auth.TwitterAuthProvider.PROVIDER_ID,
            firebase.auth.GithubAuthProvider.PROVIDER_ID,
            {
              provider: 'microsoft.com', providerName: 'Microsoft',
              buttonColor: '#2F2F2F',
              iconUrl: 'https://docs.microsoft.com/en-us/azure/active-directory/develop/media/howto-add-branding-in-azure-ad-apps/ms-symbollockup_mssymbol_19.png',
              loginHintKey: 'login_hint'
            },
            firebaseui.auth.AnonymousAuthProvider.PROVIDER_ID
          ],
          credentialHelper: firebaseui.auth.CredentialHelper.NONE,
          // tosUrl and privacyPolicyUrl accept either url string or a callback
          // function.
          // Terms of service url/callback.
          tosUrl: 'https://www.google.com',
          // Privacy policy url/callback.
          privacyPolicyUrl: function() {
            window.location.assign('https://www.google.com');
          }
        };

        // Initialize the FirebaseUI Widget using Firebase.
        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        // Auto sign-in for returning users is enabled by default except when prompt is
        // not 'none' in the Google provider custom parameters. To manually disable:
        ui.disableAutoSignIn();
        // The start method will wait until the DOM is loaded.
        ui.start('#firebaseui-auth-container', uiConfig);
      </script>
    {{ end }}

    <main role="main">
        <div class="py-5">
            <div class="container bg-light py-1 px-lg-5 py-lg-1">
                <div class="row py-1 my-2">
                    <div class="col-12 col-lg-8 offset-lg-2 text-center">
                        <h2>Hipster App Login</h2>
                        <hr/>
                        {{ template "alert" . }}
                        <div id="loading" class="d-block">Loading...</div>
                        <div id="loaded" class="d-none">
                            <div id="user-signed-in" class="d-none">
                                <div id="user-info">
                                    <div id="name"><h4></h4></div>
                                    <div id="email"></div>
                                    <div id="phone"></div>
                                </div>
                            <hr/>
                            <div class="row">
                                <div class="col">
                                </div>
                                <div class="col-lg-5 mb-3">
                                    <button id="sign-out" class="btn btn-primary btn-block" type="submit">Sign Out</button>
                                </div>
                                <div class="col">
                                </div>
                            </div>
                        </div>
                        <div id="user-signed-out" class="d-none">
                            <h4>You are signed out.</h4>
                            <div id="firebaseui-auth-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
  {{ template "footer" . }}

    {{ if $.firebase_config}}
      <script>
        /**
         * Displays the UI for a signed in user.
         * @param {!firebase.User} user
         */
        var handleSignedInUser = function(user) {
            document.getElementById('user-signed-out').className = 'd-none';
            document.getElementById('user-signed-in').className = 'd-block';
            document.getElementById('name').textContent = 'Hi ' + user.displayName + '!';
            document.getElementById('email').textContent = user.email;
            document.getElementById('phone').textContent = user.phoneNumber;
        };

        /**
         * Displays the UI for a signed out user.
         */
        var handleSignedOutUser = function() {
            document.getElementById('user-signed-in').className = 'd-none';
            document.getElementById('user-signed-out').className = 'd-block';
        };

        /**
         * handle the log-out for a user.
         */
         document.getElementById('sign-out').addEventListener('click', function() {
            console.log('signOut');
            firebase.auth().signOut();
            window.location.replace('/login');
        });

        document.addEventListener('DOMContentLoaded', function() {
            try {
                firebase.auth().onAuthStateChanged(function(user) {
                    document.getElementById('loading').className = 'd-none';
                    document.getElementById('loaded').className = 'd-block';
                    user ? handleSignedInUser(user) : handleSignedOutUser();
                });
            } catch (e) {
                // console.error('firebase.auth().onAuthStateChanged: ', e);
                var message = ' Firebase Auth ' + e + ' Try updating the <a href="/config">configuration</a>';
                var content = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>Warning!</strong> ` + message + `
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `;
                document.getElementById('firebaseui-auth-container').innerHTML =content;
            };
            try {
                let app = firebase.app();
                let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
            } catch (e) {
                console.error(e);
                document.getElementById('firebaseui-auth-container').innerHTML = 'Error loading the Identity Platform SDK, check the console.';
            };
        });
      </script>
    {{ end }}

{{ end }}
